<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Final Project</title>

    <!-- ADD Libraries-->
    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/d3/d3.svg.multibrush.js" charset="utf-8"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js" charset="utf-8"></script>
    <script src="https://cdn.datatables.net/1.10.6/js/jquery.dataTables.min.js" charset="utf-8"></script>
	<script src="https://cdn.datatables.net/plug-ins/1.10.6/integration/bootstrap/3/dataTables.bootstrap.js" charset="utf-8"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="libs/datamaps/datamaps.all.js"></script>


    <!--Stylesheets-->
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

    <!-- Get some nice font-->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>

    <script src = "js/worldmap.js"></script>
    <script src = "js/table.js"></script>
    <script src = "js/linechart.js"></script>

    <!-- add own stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

</head>
<style>
   caption {
     font-weight: bold;
     text-align: center;
     font-size: 200%
   }

   #filter_table {
        text-align: center;
   }
</style>
<body>
    <div class="container">
        <h1>Final Project</h1>

        <div class="row">
            <div class="col-md-8 col-sm-12">
               <p> Lorempisum.</p>
            </div>

        </div>

        <div class="row">
            <div id="worldmap" class="col-md-8"></div>
            <div id="linechart" class="col-md-8">
                <svg width="650" height="330"></svg>
            </div>
        </div>

        <div class="row">
            <div id="filter_table" class="col-md-8">Filter by: 
            <label><input type="checkbox" id="filter" name="Americas" value="Americas" title="Americas">Americas</input></label>
            <label><input type="checkbox" id="filter" name="Africa" value="Africa" title="Africa" >Africa</input></label>
            <label><input type="checkbox" id="filter" name="Asia" value="Asia" title="Asia">Asia</input></label>
            <label><input type="checkbox" id="filter" name="Europe" value="Europe" title="Europe" >Europe</input></label>
            <label><input type="checkbox" id="filter" name="Oceania" value="Oceania" title="Oceania" >Oceania</input></label>
            </div>
        </div>
        <div class="row">
            <div id="table" class="col-md-8"></div>
        </div>
    </div>



    <script>
        $(function(){ 


            var citiesToCities = [];
            var metaDataCities = {};
            var completeData = [];
            var airlineRouteCounts = [];
            var domesticCitiyConnectionsCountByCountry = [];
            var countriesToCountries = [];

            var dateFormatter = d3.time.format("%Y-%m-%d");


            var initVis = function(){

                var MyEventHandler = new Object();

                var table = new Table(d3.select("table"), airlineRouteCounts, MyEventHandler);
                var worldmap = new WorldMap(d3.select("#worldmap"), citiesToCities, metaDataCities, countriesToCountries, MyEventHandler);
                var linechart = new LineChart(d3.select("#linechart"), citiesToCitiesPass, metaDataCities, MyEventHandler);
        
                $(MyEventHandler).bind("selectionChanged", function(event, brush){
                      worldmap.onSelectionChange(ranges);
        
                  });

            }

            var dataLoaded = function (error, _citiesToCities, _metaDataCities, _completeTable, _airlineRouteCounts, _countriesToCountries, _citiesToCitiesPass) {

                if (!error) {

                    citiesToCities = _citiesToCities;

                    // exported to citiesToCities_noduplicates.json to optimize loading times, code below was used to generate .json
                    /*
                       citiesToCities_with_duplicates = _citiesToCities.map(function (d) {
                                return {
                                    origin: { 
                                        city: d["departure_city"],
                                        longitude: parseFloat(d["long_departure_(decimal)"]),
                                        latitude: parseFloat(d["lat_departure_(decimal)"]),
                                        country: d["departure_country"]
                                    },

                                    destination: {
                                        city: d["arrival_city"],
                                        longitude: parseFloat(d["long_arrival_(decimal)"]),
                                        latitude: parseFloat(d["lat_arrival_(decimal)"]),
                                        country: d["arrival_country"]
                                    },

                                    number_of_routes: parseInt(d["number_of_routes"])
                                };
                            }
                        )

                        console.log("start filter")
                        //TODO: make more efficient 
                        //remove duplicate items in dataset (i.e. MUC->BOS and BOS->MUC)
                        citiesToCities_with_duplicates.forEach(function(a){
                            if (citiesToCities.filter(function(b) { return b.destination.city == a.origin.city && b.origin.city == a.destination.city}).length < 1)
                                citiesToCities.push(a);
                        });
                        
                        console.log("stop filter")

                        d3.select("body").append("pre").text(JSON.stringify(citiesToCities, null, 4));

                    */

                        metaDataCities = _metaDataCities.map(function (d) {
            
                            return {
                                name: d["city_name"],
                                country: d["country_name"],
                                most_active_airport: {
                                    name: d["most_active_airport"],
                                    longitude: d["long_most_active_airport"],
                                    latitude: d["lat_most_active_airport"],
                                },

                                avg_distance: parseInt(d["average_distance"]),
                                max_distance: parseInt(d["max._distance"]),
                                number_incoming_domestic_flights: parseInt(d["number_incoming_domestic_flights"]),
                                number_incoming_flights: parseInt(d["number_incoming_flights"]),
                                number_incoming_international_flights: parseInt(d["number_incoming_international_flights"]),
                                number_of_routes: parseInt(d["number_of_routes"]),
                                number_outcoming_domestic_flights: parseInt(d["number_outcoming_domestic_flights"]),
                                number_outcoming_flights: parseInt(d["number_outcoming_flights"]),
                                number_outcoming_international_flights: parseInt(d["number_outcoming_international_flights"]),
                                only_domestic_flights: (d["only_domestic_flights"] == 1 ? true : false)
                            } 
                        });

                        airlineRouteCounts = _airlineRouteCounts;

                        //exported to airlineRouteCounts.json to optimize loading times, code below was used to generate .json
                        /*

                        var i = 0
                        prev = ""
                        _completeTable.forEach(function(d){
                            if (airlineRouteCounts.length == 0 || prev != d["airline name"])
                            {
                                var res = {};
                                res.count = 0
                                res.airline = d["airline name"]
                                res.country = d["airline country"]
                                res.continent = d["airline continent"]
                                prev = d["airline name"]
                                _completeTable.forEach(function(e){
                                    if (e["airline name"] == res.airline)
                                    {
                                        res.count++;
                                    }
                                })
                                airlineRouteCounts[i] = res;
                                i++;
                            }
                        })

                        airlineRouteCounts.sort(function(a,b){
                            return d3.descending(a.count, b.count)
                        })

                           d3.select("body").append("pre").text(JSON.stringify(airlineRouteCounts, null, 4));
                        */

                        /*console.log("start filter")
                        _completeTable.forEach(function(a){

                            if (airportToAirport.filter(function(b) {
                                return b["arrival airport"] == a["departure airport"] && b["departure airport"] == a["departure airport"]
                                || b["arrival airport"] == a["arrival airport"] && b["departure airport"] == a["departure airport"] 
                            }).length < 1) {
                                a["airline name"] = undefined; // better performance than delete, and also works if we export a JSON file afterwards
                                a["airline country"] = undefined;
                                a["airline continent"] = undefined;
                                a["active airline"] = undefined;
                                airportToAirport.push(a);
                            }
                             
                        });
                        
                        console.log("stop filter");
                        debugger;
                        */

                    domesticCitiyConnectionsCountByCountry = d3.nest()
                        .key(function(d) { return d.origin.country; })
                        .rollup(function(leaves) { return leaves.length; })
                        .entries(citiesToCities.filter(function(d) { return d.origin.country == d.destination.country}))
                        .sort(function(a,b) { return b.values - a.values; });




                        countriesToCountries = _countriesToCountries.map(function (d) {
            
                            return {
                                origin: {
                                    country: d["country departure"],
                                    longitude: parseFloat(d["departure longitude"]),
                                    latitude: parseFloat(d["departure latitude"]),
                                },
                                destination: {
                                    country: d["country arrival"],
                                    longitude: parseFloat(d["arrival longitude"]),
                                    latitude: parseFloat(d["arrival latitude"]),
                                },

                                number_of_routes: parseInt(d["number of routes"])
                            } 
                        });


                       /* var countries = countriesToCountries.map(function(d) { return d.origin.country}).concat(countriesToCountries.map(function(d) { return d.destination.country}));
                        countries = countries.filter(function(v,i) { return countries.indexOf(v) == i; }).sort();

                      

                        var failed = [];

                        var country = "";

                        var finished = 0;

                        for (var i = countries.length - 1; i >= 0; i--) {
                            country = countries[i];

                           // var e = new Date().getTime() + (0.5 * 1000);
                            //while (new Date().getTime() <= e) {}

                             d3.json("http://maps.googleapis.com/maps/api/geocode/json?language=en&address=" + country, function(error, json) {
                                var google_country_name = google_country_name;
                            
                                finished++;
                                if (finished == countries.length)
                                    debugger;

                                if (json.status != "OK")
                                    {
                                        console.log(google_country_name);
                                        return;
                                    }
                                countriesToCountries
                                    .filter(function(n) { return n.origin.country == google_country_name; })
                                    .forEach(function(n) { 
                                        n.origin.longitude = json.results[0].geometry.location.lng;
                                        n.origin.latitude = json.results[0].geometry.location.lat;
                                    })

                                countriesToCountries
                                    .filter(function(n) { return n.destination.country == google_country_name; })
                                    .forEach(function(n) { 
                                        n.destination.longitude = json.results[0].geometry.location.lng;
                                        n.destination.latitude = json.results[0].geometry.location.lat;
                                    })

                                console.log(google_country_name + ": " + countriesToCountries
                                    .filter(function(n) { return n.origin.country == google_country_name; }).length + " " + countriesToCountries
                                    .filter(function(n) { return n.destination.country == google_country_name; }))
                            });
                        }*/
                    citiesToCitiesPass = _citiesToCitiesPass.map(function (d){
                        return {
                            departure_city: d["depCity"],
                            departure_country : d["depCountry"],
                            arrival_city: d["arrCity"],
                            arrival_country: d["arrCountry"],
                            no_1990: d["pass_1990"],
                            no_1995: d["pass_1995"],
                            no_2000: d["pass_2000"],
                            no_2005: d["pass_2005"],
                            no_2010: d["pass_2010"]
                        }
                    })
                       
                    initVis();
                }
                else {
                    console.log(error);
                }
            }
			
			
			// HELPERS 


            var dateFormat = d3.time.format("%Y-%m-%d");

            var startHere = function(){

            	queue()
                .defer(d3.json, 'data/openflight_db/citiesToCities_noduplicates.json')
                .defer(d3.csv, 'data/openflight_db/citiesTable.csv')
                .defer(d3.csv, 'data/openflight_db/completeTable.csv')  
                .defer(d3.json, 'data/openflight_db/airlineRoutesCounts.json')  
                .defer(d3.csv, 'data/openflight_db/countriesToCountries.csv')
                .defer(d3.csv, 'data/openflight_db/citiesToCitiesPassFormatted.csv') 
				.await(dataLoaded);

            }

            startHere();
        })
    </script>
</body>
</html>
