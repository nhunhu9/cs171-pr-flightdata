<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Flight Data</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/myStyle.css" rel="stylesheet">
    <!--pic source: http://pichost.me/1684227/-->
</head>

<body>
<div class="container">
    <!-- row 1: navigation -->
    <div class="row">
    	<nav class="navbar navbar-default navbar-fixed-top navbar-inverse">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="glyphicon glyphicon-arrow-down"></span>
                  MENU
                </button>
            </div>
            <div class="collapse navbar-collapse" id="collapse">
                <div class="container">
                    <h2 id="name" class="nav navbar-nav navbar-left"><a href="index.html">Flight Data</a></h2>
                <ul class="nav navbar-nav navbar-right links">
                    <li class="active"><a href="about.html">Home Page</a></li>
                    <li><a href="flight.html">Visualization</a></li>
                    <li><a href="#">Process Book</a></li>
                </ul> 
                </div>
            </div>

         </nav> 
    </div>
</div>
    <div class="jumbotron">
      <div class="intro">
        <h1 style="font-size: 100px;">Flight Data</h1> 
        <h2>Zeno Ziemke, Masahiro Kusunoki, Nhu Nguyen</h2> 
        <h2>CS171: Visualization </h2>
        <a href="flight.html" class="btn btn-default btn-lg">
          <span class="network-name">Fly awayyy</span>
        </a>
      </div>
    </div>

            <div id="barchart1" class="col-md-2"></div>
        </div>

        <div class="row">
            <div id="filter_table" class="col-md-8">Filter by: 
            <label><input type="checkbox" class="continent_filter" name="Americas" value="Americas" title="Americas">Americas</input></label>
            <label><input type="checkbox" class="continent_filter" name="Africa" value="Africa" title="Africa" >Africa</input></label>
            <label><input type="checkbox" class="continent_filter" name="Asia" value="Asia" title="Asia">Asia</input></label>
            <label><input type="checkbox" class="continent_filter" name="Europe" value="Europe" title="Europe" >Europe</input></label>
            <label><input type="checkbox" class="continent_filter" name="Oceania" value="Oceania" title="Oceania" >Oceania</input></label>
            </div>
        </div>
        <div class="row">
            <div id="table" class="col-md-8"></div>
        </div>
    </div>



    <script>
        $(function(){ 


            var citiesToCities = [];
            var metaDataCities = {};
            var completeData = [];
            var airlineRouteCounts = [];
            var domesticCitiyConnectionsCountByCountry = [];
            var countriesToCountries = [];

            var dateFormatter = d3.time.format("%Y-%m-%d");


            var initVis = function(){

                var MyEventHandler = new Object();
                
                var barchart1 = new BarChart(d3.select("#barchart1"), metaDataCities, MyEventHandler);
               debugger;
                var table = new Table(d3.select("table"), airlineRouteCounts, MyEventHandler);
                var worldmap = new WorldMap(d3.select("#worldmap"), citiesToCities, metaDataCities, countriesToCountries, MyEventHandler);
                var linechart = new LineChart(d3.select("#linechart"), citiesToCitiesPassFormatted, metaDataCities, MyEventHandler);
                
                $(MyEventHandler).bind("selectionChanged", function(event, args){

                    console.log(args);
                    barchart1.onSelectionChange(args);
        
                  });

            }

            var dataLoaded = function (error, _citiesToCities, _metaDataCities, _completeTable, _airlineRouteCounts, _countriesToCountries, _citiesToCitiesPassFormatted, _citiesToCitiesPass) {

                if (!error) {

                    citiesToCities = _citiesToCities;

                    // exported to citiesToCities_noduplicates.json to optimize loading times, code below was used to generate .json
                    /*
                       citiesToCities_with_duplicates = _citiesToCities.map(function (d) {
                                return {
                                    origin: { 
                                        city: d["departure_city"],
                                        longitude: parseFloat(d["long_departure_(decimal)"]),
                                        latitude: parseFloat(d["lat_departure_(decimal)"]),
                                        country: d["departure_country"]
                                    },

                                    destination: {
                                        city: d["arrival_city"],
                                        longitude: parseFloat(d["long_arrival_(decimal)"]),
                                        latitude: parseFloat(d["lat_arrival_(decimal)"]),
                                        country: d["arrival_country"]
                                    },

                                    number_of_routes: parseInt(d["number_of_routes"])
                                };
                            }
                        )

                        console.log("start filter")
                        //TODO: make more efficient 
                        //remove duplicate items in dataset (i.e. MUC->BOS and BOS->MUC)
                        citiesToCities_with_duplicates.forEach(function(a){
                            if (citiesToCities.filter(function(b) { return b.destination.city == a.origin.city && b.origin.city == a.destination.city}).length < 1)
                                citiesToCities.push(a);
                        });
                        
                        console.log("stop filter")

                        d3.select("body").append("pre").text(JSON.stringify(citiesToCities, null, 4));

                    */

                        metaDataCities = _metaDataCities.map(function (d) {
            
                            return {
                                name: d["city_name"],
                                country: d["country_name"],
                                most_active_airport: {
                                    name: d["most_active_airport"],
                                    longitude: d["long_most_active_airport"],
                                    latitude: d["lat_most_active_airport"],
                                },

                                avg_distance: parseInt(d["average_distance"]),
                                max_distance: parseInt(d["max._distance"]),
                                number_incoming_domestic_flights: parseInt(d["number_incoming_domestic_flights"]),
                                number_incoming_flights: parseInt(d["number_incoming_flights"]),
                                number_incoming_international_flights: parseInt(d["number_incoming_international_flights"]),
                                number_of_routes: parseInt(d["number_of_routes"]),
                                number_outcoming_domestic_flights: parseInt(d["number_outcoming_domestic_flights"]),
                                number_outcoming_flights: parseInt(d["number_outcoming_flights"]),
                                number_outcoming_international_flights: parseInt(d["number_outcoming_international_flights"]),
                                only_domestic_flights: (d["only_domestic_flights"] == 1 ? true : false)
                            } 
                        });


                        airlineRouteCounts = _airlineRouteCounts;

                        //exported to airlineRouteCounts.json to optimize loading times, code below was used to generate .json
                        /*

                        var i = 0
                        prev = ""
                        _completeTable.forEach(function(d){
                            if (airlineRouteCounts.length == 0 || prev != d["airline name"])
                            {
                                var res = {};
                                res.count = 0
                                res.airline = d["airline name"]
                                res.country = d["airline country"]
                                res.continent = d["airline continent"]
                                prev = d["airline name"]
                                _completeTable.forEach(function(e){
                                    if (e["airline name"] == res.airline)
                                    {
                                        res.count++;
                                    }
                                })
                                airlineRouteCounts[i] = res;
                                i++;
                            }
                        })

                        airlineRouteCounts.sort(function(a,b){
                            return d3.descending(a.count, b.count)
                        })

                           d3.select("body").append("pre").text(JSON.stringify(airlineRouteCounts, null, 4));
                        */

                        /*console.log("start filter")
                        _completeTable.forEach(function(a){

                            if (airportToAirport.filter(function(b) {
                                return b["arrival airport"] == a["departure airport"] && b["departure airport"] == a["departure airport"]
                                || b["arrival airport"] == a["arrival airport"] && b["departure airport"] == a["departure airport"] 
                            }).length < 1) {
                                a["airline name"] = undefined; // better performance than delete, and also works if we export a JSON file afterwards
                                a["airline country"] = undefined;
                                a["airline continent"] = undefined;
                                a["active airline"] = undefined;
                                airportToAirport.push(a);
                            }
                             
                        });
                        
                        console.log("stop filter");
                        debugger;
                        */

                    domesticCitiyConnectionsCountByCountry = d3.nest()
                        .key(function(d) { return d.origin.country; })
                        .rollup(function(leaves) { return leaves.length; })
                        .entries(citiesToCities.filter(function(d) { return d.origin.country == d.destination.country}))
                        .sort(function(a,b) { return b.values - a.values; });




                        countriesToCountries = _countriesToCountries.map(function (d) {
            
                            return {
                                origin: {
                                    country: d["country departure"],
                                    longitude: parseFloat(d["departure longitude"]),
                                    latitude: parseFloat(d["departure latitude"]),
                                },
                                destination: {
                                    country: d["country arrival"],
                                    longitude: parseFloat(d["arrival longitude"]),
                                    latitude: parseFloat(d["arrival latitude"]),
                                },

                                number_of_routes: parseInt(d["number of routes"])
                            } 
                        });


                       /* var countries = countriesToCountries.map(function(d) { return d.origin.country}).concat(countriesToCountries.map(function(d) { return d.destination.country}));
                        countries = countries.filter(function(v,i) { return countries.indexOf(v) == i; }).sort();

                      

                        var failed = [];

                        var country = "";

                        var finished = 0;

                        for (var i = countries.length - 1; i >= 0; i--) {
                            country = countries[i];

                           // var e = new Date().getTime() + (0.5 * 1000);
                            //while (new Date().getTime() <= e) {}

                             d3.json("http://maps.googleapis.com/maps/api/geocode/json?language=en&address=" + country, function(error, json) {
                                var google_country_name = google_country_name;
                            
                                finished++;
                                if (finished == countries.length)
                                    debugger;

                                if (json.status != "OK")
                                    {
                                        console.log(google_country_name);
                                        return;
                                    }
                                countriesToCountries
                                    .filter(function(n) { return n.origin.country == google_country_name; })
                                    .forEach(function(n) { 
                                        n.origin.longitude = json.results[0].geometry.location.lng;
                                        n.origin.latitude = json.results[0].geometry.location.lat;
                                    })

                                countriesToCountries
                                    .filter(function(n) { return n.destination.country == google_country_name; })
                                    .forEach(function(n) { 
                                        n.destination.longitude = json.results[0].geometry.location.lng;
                                        n.destination.latitude = json.results[0].geometry.location.lat;
                                    })

                                console.log(google_country_name + ": " + countriesToCountries
                                    .filter(function(n) { return n.origin.country == google_country_name; }).length + " " + countriesToCountries
                                    .filter(function(n) { return n.destination.country == google_country_name; }))
                            });
                        }*/
                    citiesToCitiesPassFormatted = _citiesToCitiesPassFormatted.map(function (d){
                        return {
                            departure_city: d["depCity"],
                            departure_country : d["depCountry"],
                            arrival_city: d["arrCity"],
                            arrival_country: d["arrCountry"],
                            no_1990: d["pass_1990"],
                            no_1995: d["pass_1995"],
                            no_2000: d["pass_2000"],
                            no_2005: d["pass_2005"],
                            no_2010: d["pass_2010"]
                        }
                    })
                       

                    citiesToCitiesPass = _citiesToCitiesPass.map(function (d) {

        
       

<!-- javascript -->
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
</body>
</html>
