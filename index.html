<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Final Project</title>

    <!-- ADD Libraries-->
    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/d3/d3.svg.multibrush.js" charset="utf-8"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
	<script src="http://d3js.org/queue.v1.min.js" charset="utf-8"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="libs/datamaps/datamaps.all.js"></script>


    <!--Stylesheets-->
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

    <!-- Get some nice font-->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>

    <script src = "js/worldmap.js"></script>

    <!-- add own stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

</head>
<body>
    <div class="container">
        <h1>Final Project</h1>

        <div class="row">
            <div class="col-md-8 col-sm-12">
               <p> Lorempisum.</p>
            </div>

        </div>

        <div class="row">
            <div id="worldmap" class="col-md-8"></div>
        </div>
    </div>



    <script>
        $(function(){ 


            var citiesToCities = [];
            var metaDataCities = {};

            var dateFormatter = d3.time.format("%Y-%m-%d");


            var initVis = function(){

                var MyEventHandler = new Object();


               var worldmap = new WorldMap(d3.select("#worldmap"), citiesToCities, metaDataCities, MyEventHandler);
          
                 $(MyEventHandler).bind("selectionChanged", function(event, brush){
                      worldmap.onSelectionChange(ranges);
        
                  });

            }

            var dataLoaded = function (error, _citiesToCities, _metaDataCities) {

                if (!error) {

                       citiesToCities = _citiesToCities.map(function (d) {
                                return {
                                    origin: { 
                                        city: d["departure_city"],
                                        longitude: parseFloat(d["long_departure_(decimal)"]),
                                        latitude: parseFloat(d["lat_departure_(decimal)"]),
                                        country: d["departure_country"]
                                    },

                                    destination: {
                                        city: d["arrival_city"],
                                        longitude: parseFloat(d["long_arrival_(decimal)"]),
                                        latitude: parseFloat(d["lat_arrival_(decimal)"]),
                                        country: d["arrival_country"]
                                    },

                                    number_of_routes: parseInt(d["number_of_routes"])
                                };
                            }
                        )
                    
                     
/*                      var citiesToCities = [];
                        console.log("start filter")
                        //TODO: make more efficient 
                        //remove duplicate items in dataset (i.e. MUC->BOS and BOS->MUC)
                        citiesToCities_with_duplicates.forEach(function(a){

                            if (citiesToCities.filter(function(b) { return b.destination == a.origin && b.origin == a.destination}).length < 1)
                                citiesToCities.push(a);
                        });
                        
                        console.log("stop filter")*/
    
                        metaDataCities = _metaDataCities.map(function (d) {
            
                            return {
                                name: d["city_name"],
                                country: d["country_name"],
                                most_active_airport: {
                                    name: d["most_active_airport"],
                                    longitude: d["long_most_active_airport"],
                                    latitude: d["lat_most_active_airport"],
                                },

                                avg_distance: parseInt(d["average_distance"]),
                                max_distance: parseInt(d["max._distance"]),
                                number_incoming_domestic_flights: parseInt(d["number_incoming_domestic_flights"]),
                                number_incoming_flights: parseInt(d["number_incoming_flights"]),
                                number_incoming_international_flights: parseInt(d["number_incoming_international_flights"]),
                                number_of_routes: parseInt(d["number_of_routes"]),
                                number_outcoming_domestic_flights: parseInt(d["number_outcoming_domestic_flights"]),
                                number_outcoming_flights: parseInt(d["number_outcoming_flights"]),
                                number_outcoming_international_flights: parseInt(d["number_outcoming_international_flights"]),
                                only_domestic_flights: (d["only_domestic_flights"] == 1 ? true : false)
                            } 
                    });

                    initVis();
                } else {
                    console.log(error);
                }
            }
			
			
			// HELPERS 


            var dateFormat = d3.time.format("%Y-%m-%d");

            var startHere = function(){

            	queue()
				.defer(d3.csv, 'data/openflight_db/citiesToCities.csv') 
				.defer(d3.csv, 'data/openflight_db/citiesTable.csv') 
				.await(dataLoaded);

            }

            startHere();
        })
    </script>
</body>
</html>
