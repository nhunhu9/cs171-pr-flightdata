<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Final Project</title>

    <!-- ADD Libraries-->
    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/d3/d3.svg.multibrush.js" charset="utf-8"></script>
    <script src="libs/d3/d3.legend.js" charset="utf-8"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js" charset="utf-8"></script>
    <script src="https://cdn.datatables.net/1.10.6/js/jquery.dataTables.min.js" charset="utf-8"></script>
	<script src="https://cdn.datatables.net/plug-ins/1.10.6/integration/bootstrap/3/dataTables.bootstrap.js" charset="utf-8"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="libs/datamaps/datamaps.all.js"></script>


    <!--Stylesheets-->
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

    <!-- Get some nice font-->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>

    <script src = "js/worldmap.js"></script>
    <script src = "js/table.js"></script>
    <script src = "js/linechart.js"></script>
    <script src = "js/barchart.js"></script>
    <script src = "js/stringHelpers.js"></script>

    <!-- add own stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

</head>
<body>
<div class="container" >
    <!-- row 1: navigation -->
    <header class="nav">
        <nav id="menu-bar">
            <div class="nav-title">
                <a href="flight.html">Flight Visualization</a>
            </div>
            <div class ="nav-links1">
                <a href="http:://youtube.com">Demo Video</a>
            </div>
            <div class ="nav-links2">
                <a href="#">Process Book</a>
            </div>
        </nav>
    </header>
</div>
    
<div class="container">   
    <div id="title"></div>

    <div class="row">
        <div class="col-md-8 col-sm-12">
           <p></p>
        </div>

    </div>
    <div class="row">
       
    </div>
    <div class="row">
         <h3 class="heading" id="routevis"> Route Visualization </h3>
        <div id="worldmap" class="col-md-5">
             <div class="btn-group" role="group" aria-label="..." id="filter_table">
              <button type="button" class="btn btn-default continent_filter" name="Americas">Americas</button>
              <button type="button" class="btn btn-default continent_filter" name="Africa">Africa</button>
              <button type="button" class="btn btn-default continent_filter" name="Asia">Asia</button>
              <button type="button" class="btn btn-default continent_filter" name="Europe">Europe</button>
              <button type="button" class="btn btn-default continent_filter" name="Oceania">Oceania</button>
            </div>
        </div>
        <div id="linechart" class="col-md-3">
            <h3 class="heading"> Passenger Numbers </h3>
            <svg class="line" width="500" height="270"></svg>
        </div>
        
        <div id="barchart2" class="col-md-3"></div>
    </div>

    <div class="row bottom" style="width:1500px;">
        <div id="table" class="col-md-5">
                <h3 class="heading" > Airline Ranking </h3>
        </div>
        <!--start accordion-->
         <div class="panel-group col-md-4" id="accordion">
         <h3 class="heading storyheading">Stories</h3>
         <div class="storypanel">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">
                    <a href="#story1" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion"><span class="glyphicon glyphicon-plane"></span> Story 1 Title</a>
              </h4>
            </div>
                <div id="story1" class="panel-collapse collapse">
              <div class="panel-body">
                <p>Story 1</p>
              </div>
            </div>
          </div>     
               
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">
                <a href="#story2" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion"><span class="glyphicon glyphicon-plane"></span> Story 2 Title</a>
              </h4>
            </div>
            <div id="story2" class="panel-collapse collapse">
              <div class="panel-body">
                <p>Story 2</p>
               </div>
            </div>
          </div>     
               
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">
                <a href="#story3" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion"> <span class="glyphicon glyphicon-plane"></span> Story 3 Title</a>
              </h4>
            </div>
            <div id="story3" class="panel-collapse collapse">
              <div class="panel-body">
                <p>Story 3</p>
              </div>
            </div>
          </div>     
               
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">
                <a href="#story4" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion"><span class="glyphicon glyphicon-plane"></span> Story 4 Title</a>
              </h4>
            </div>
            <div id="story4" class="panel-collapse collapse">
              <div class="panel-body">
                <p>Story 4</p>
              </div>
            </div>
          </div>
          </div>    
        </div><!-- end accordion --> 
    </div>


</div>



    <script>
        $(function(){ 


            var citiesToCities = [];
            var metaDataCities = {};
            var completeTable = [];
            var completeData = [];
            var airlineRouteCounts = [];
            var domesticCitiyConnectionsCountByCountry = [];
            var countriesToCountries = [];

            var dateFormatter = d3.time.format("%Y-%m-%d");


            var initVis = function(){

                var MyEventHandler = new Object();
                
             
                var barchart2 = new BarChart(d3.select("#barchart2"), metaDataCities, MyEventHandler);  
                 var table = new Table(d3.select("table"), completeData, MyEventHandler);

                var worldmap = new WorldMap(d3.select("#worldmap"), citiesToCities, metaDataCities, countriesToCountries, completeTable, MyEventHandler);
                var linechart = new LineChart(d3.select("#linechart"), UNData, MyEventHandler);
                
                $(MyEventHandler).bind("selectionChanged", function(event, args){
                    console.log(args)
                    barchart2.onSelectionChange(args);
                    linechart.onSelectionChange(args);
                    table.onSelectionChange(args);

                    worldmap.args = args;
        
                  });

                //  Link airline ranking with map
                $("#table").on("click","tr.row", function() {
                    worldmap.showAirlineRoutes(d3.select(this.children[0]).text())
                })  

            }

            var dataLoaded = function (error, _citiesToCities, _metaDataCities, _completeTable, _airlineRouteCounts, _countriesToCountries, _countryList, _UNData) {

                if (!error) {

                        countryList = {};
                    _countryList.map(function(d){
                        countryList[d["name"]] = d["continent"];
                    });

                    citiesToCities = _citiesToCities;

                     completeTable = _completeTable.map(function (d) {
            
                            return {
                                origin: {
                                    country: d["departure country"],
                                    continent: (countryList[d["departure country"].toTitleCase()]) ? countryList[d["departure country"].toTitleCase()] : "Unknown",
                                    longitude: parseFloat(d["long. departure (decimal)"]),
                                    latitude: parseFloat(d["lat. departure (decimal)"]),
                                },
                                destination: {
                                   country: d["arrival country"],
                                   continent: (countryList[d["arrival country"].toTitleCase()]) ? countryList[d["arrival country"].toTitleCase()] : "Unknown",
                                    longitude: parseFloat(d["long. arrival (decimal)"]),
                                    latitude: parseFloat(d["lat. arrival (decimal)"]),
                                },

                                airline_name: d["airline name"]
                            } 
                        });
                    
                    airlineRouteCounts = _airlineRouteCounts;

                        
                    domesticCitiyConnectionsCountByCountry = d3.nest()
                        .key(function(d) { return d.origin.country; })
                        .rollup(function(leaves) { return leaves.length; })
                        .entries(citiesToCities.filter(function(d) { return d.origin.country == d.destination.country}))
                        .sort(function(a,b) { return b.values - a.values; });




                        countriesToCountries = _countriesToCountries.map(function (d) {
            
                            return {
                                origin: {
                                    country: d["country departure"],
                                    continent: (countryList[d["country departure"].toTitleCase()]) ? countryList[d["country departure"].toTitleCase()] : "Unknown",
                                    longitude: parseFloat(d["departure longitude"]),
                                    latitude: parseFloat(d["departure latitude"]),
                                },
                                destination: {
                                    country: d["country arrival"],
                                    continent: (countryList[d["country arrival"].toTitleCase()]) ? countryList[d["country arrival"].toTitleCase()] : "Unknown",
                                    longitude: parseFloat(d["arrival longitude"]),
                                    latitude: parseFloat(d["arrival latitude"]),
                                },

                                number_of_routes: parseInt(d["number of routes"])
                            } 
                        });


                

                    UNData = Object.keys(_UNData).map(function(d){
                        return {
                            name: d.toTitleCase(),
                            continent: (countryList[d.toTitleCase()]) ? countryList[d.toTitleCase()] : "Unknown",
                            data: _UNData[d]
                        }
                    });

                    
                    // console unknowns
                    // UNData.map(function(d){
                    //     if (d.continent != "Unknown"){
                    //         console.log(d);
                    //     }
                    // })

                    //DATA FOR THE TABLE
                    var i = 0
                    prev = ""

                    _completeTable.forEach(function(d){
                        if (completeData.length == 0 || prev != d["airline name"])
                        {
                            var res = {};
                            res.count = 0
                            res.airline = d["airline name"]
                            res.country = d["airline country"]
                            res.continent = d["airline continent"]
                            prev = d["airline name"]
                            _completeTable.forEach(function(e){
                                if (e["airline name"] == res.airline)
                                {
                                    res.count++;
                                }
                            })
                            completeData[i] = res;
                            i++;
                        }
                    })


                    //END DATA FOR TABLE

                
                    metaDataCities = _metaDataCities.map(function (d) {
        
                        return {
                            name: d["city_name"],
                            country: d["country_name"],
                            continent: (countryList[d["country_name"].toTitleCase()]) ? countryList[d["country_name"].toTitleCase()] : "Unknown",
                            most_active_airport: {
                                name: d["most_active_airport"],
                                longitude: d["long_most_active_airport"],
                                latitude: d["lat_most_active_airport"],
                            },

                            avg_distance: parseInt(d["average_distance"]),
                            max_distance: parseInt(d["max._distance"]),
                            number_incoming_domestic_flights: parseInt(d["number_incoming_domestic_flights"]),
                            number_incoming_flights: parseInt(d["number_incoming_flights"]),
                            number_incoming_international_flights: parseInt(d["number_incoming_international_flights"]),
                            number_of_routes: parseInt(d["number_of_routes"]),
                            number_outcoming_domestic_flights: parseInt(d["number_outcoming_domestic_flights"]),
                            number_outcoming_flights: parseInt(d["number_outcoming_flights"]),
                            number_outcoming_international_flights: parseInt(d["number_outcoming_international_flights"]),
                            only_domestic_flights: (d["only_domestic_flights"] == 1 ? true : false)
                        } 
                    });


                    initVis();
                }
                else {
                    console.log(error);
                }
            }
			

			
			// HELPERS 


            var dateFormat = d3.time.format("%Y-%m-%d");

            var startHere = function(){

            	queue()
                .defer(d3.json, 'data/openflight_db/citiesToCities_noduplicates.json')
                .defer(d3.csv, 'data/openflight_db/citiesTable.csv')
                .defer(d3.csv, 'data/openflight_db/completeTable.csv')  
                .defer(d3.json, 'data/openflight_db/airlineRoutesCounts.json')  
                .defer(d3.csv, 'data/openflight_db/countriesToCountries.csv') 
                .defer(d3.csv, 'data/countrylist.csv')
                .defer(d3.json, 'data/UNData.json')
				.await(dataLoaded);

            }

            startHere();
        })
    </script>
</body>
</html>