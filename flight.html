<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Final Project</title>

    <!-- ADD Libraries-->
    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/d3/d3.svg.multibrush.js" charset="utf-8"></script>
    <script src="libs/d3/d3.legend.js" charset="utf-8"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js" charset="utf-8"></script>
    <script src="https://cdn.datatables.net/1.10.6/js/jquery.dataTables.min.js" charset="utf-8"></script>
	<script src="https://cdn.datatables.net/plug-ins/1.10.6/integration/bootstrap/3/dataTables.bootstrap.js" charset="utf-8"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="libs/datamaps/datamaps.all.js"></script>


    <!--Stylesheets-->
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

    <!-- Get some nice font-->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>

    <script src = "js/worldmap.js"></script>
    <script src = "js/table.js"></script>
    <script src = "js/linechart.js"></script>
    <script src = "js/barchart.js"></script>
    <script src = "js/stringHelpers.js"></script>

    <!-- add own stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

</head>
<body>
<div class="container">
    <!-- row 1: navigation -->
    <div class="row">
        <nav class="navbar navbar-default navbar-fixed-top navbar-inverse">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="glyphicon glyphicon-arrow-down"></span>
                  MENU
                </button>
            </div>
            <div class="collapse navbar-collapse" id="collapse">
                <div class="container">
                    <h2 id="name" class="nav navbar-nav navbar-left"><a href="index.html">Flight Data</a></h2>
                <ul class="nav navbar-nav navbar-right links">
                    <li class="active"><a href="about.html">Home Page</a></li>
                    <li><a href="flight.html">Visualization</a></li>
                    <li><a href="#">Process Book</a></li>
                </ul> 
                </div>
            </div>
         </nav> 
    </div>
</div>
    
    <div class="container">   
        <h1 id="title">Final Project - Flight Data</h1>

        <div class="row">
            <div class="col-md-8 col-sm-12">
               <p></p>
            </div>

        </div>
        <div class="row">
           
        </div>
        <div class="row" style="width:1800px;">
             <h3 class="heading" id="routevis"> Route Visualization <br>
             <div class="btn-group" role="group" aria-label="..." id="filter_table">
                  <button type="button" class="btn btn-default continent_filter" name="Americas">Americas</button>
                  <button type="button" class="btn btn-default continent_filter" name="Africa">Africa</button>
                  <button type="button" class="btn btn-default continent_filter" name="Asia">Asia</button>
                  <button type="button" class="btn btn-default continent_filter" name="Europe">Europe</button>
                  <button type="button" class="btn btn-default continent_filter" name="Oceania">Oceania</button>
            </div>
            </h3>
            <div id="worldmap" class="col-md-7"></div>
            <div id="linechart" class="col-md-6">
                <h3 class="heading"> Passenger Numbers </h3>
                <svg class="line" width="650" height="330"></svg>
            </div>
            
            <div id="barchart2" class="col-md-3">
                <h3 class="heading"> Top 10 Flight Destination (Worldwide) </h3>
            </div>
        </div>

        <div class="row bottom">
        <div id="table">
                <h3 class="heading" > Airline Ranking </h3>
            </div>
            
            
        </div>
    </div>



    <script>
        $(function(){ 


            var citiesToCities = [];
            var metaDataCities = {};
            var completeData = [];
            var airlineRouteCounts = [];
            var domesticCitiyConnectionsCountByCountry = [];
            var countriesToCountries = [];

            var dateFormatter = d3.time.format("%Y-%m-%d");


            var initVis = function(){

                var MyEventHandler = new Object();
                
             
                var barchart2 = new BarChart(d3.select("#barchart2"), metaDataCities, MyEventHandler);  
                 var table = new Table(d3.select("table"), completeData, MyEventHandler);

                var worldmap = new WorldMap(d3.select("#worldmap"), citiesToCities, metaDataCities, countriesToCountries, MyEventHandler);
                var linechart = new LineChart(d3.select("#linechart"), UNData, MyEventHandler);
                
                $(MyEventHandler).bind("selectionChanged", function(event, args){
                    console.log(args);
                    barchart2.onSelectionChange(args);
                    linechart.onSelectionChange(args);
        
                  });

            }

            var dataLoaded = function (error, _citiesToCities, _metaDataCities, _completeTable, _airlineRouteCounts, _countriesToCountries, _countryList, _UNData) {

                if (!error) {

                    citiesToCities = _citiesToCities;
                    
                    airlineRouteCounts = _airlineRouteCounts;

                        
                    domesticCitiyConnectionsCountByCountry = d3.nest()
                        .key(function(d) { return d.origin.country; })
                        .rollup(function(leaves) { return leaves.length; })
                        .entries(citiesToCities.filter(function(d) { return d.origin.country == d.destination.country}))
                        .sort(function(a,b) { return b.values - a.values; });




                        countriesToCountries = _countriesToCountries.map(function (d) {
            
                            return {
                                origin: {
                                    country: d["country departure"],
                                    longitude: parseFloat(d["departure longitude"]),
                                    latitude: parseFloat(d["departure latitude"]),
                                },
                                destination: {
                                    country: d["country arrival"],
                                    longitude: parseFloat(d["arrival longitude"]),
                                    latitude: parseFloat(d["arrival latitude"]),
                                },

                                number_of_routes: parseInt(d["number of routes"])
                            } 
                        });


                    countryList = {};
                    _countryList.map(function(d){
                        countryList[d["name"]] = d["continent"];
                    });

                    UNData = Object.keys(_UNData).map(function(d){
                        return {
                            name: d.toTitleCase(),
                            continent: (countryList[d.toTitleCase()]) ? countryList[d.toTitleCase()] : "Unknown",
                            data: _UNData[d]
                        }
                    });

                    
                    // console unknowns
                    // UNData.map(function(d){
                    //     if (d.continent != "Unknown"){
                    //         console.log(d);
                    //     }
                    // })

                    //DATA FOR THE TABLE
                    var i = 0
                    prev = ""
                    _completeTable.forEach(function(d){
                        if (completeData.length == 0 || prev != d["airline name"])
                        {
                            var res = {};
                            res.count = 0
                            res.airline = d["airline name"]
                            res.country = d["airline country"]
                            res.continent = d["airline continent"]
                            prev = d["airline name"]
                            _completeTable.forEach(function(e){
                                if (e["airline name"] == res.airline)
                                {
                                    res.count++;
                                }
                            })
                            completeData[i] = res;
                            i++;
                        }
                    })

                    completeData.sort(function(a,b){
                        return d3.descending(a.count, b.count)
                    })
                    //END DATA FOR TABLE

                
                    metaDataCities = _metaDataCities.map(function (d) {
        
                        return {
                            name: d["city_name"],
                            country: d["country_name"],
                            continent: (countryList[d["country_name"].toTitleCase()]) ? countryList[d["country_name"].toTitleCase()] : "Unknown",
                            most_active_airport: {
                                name: d["most_active_airport"],
                                longitude: d["long_most_active_airport"],
                                latitude: d["lat_most_active_airport"],
                            },

                            avg_distance: parseInt(d["average_distance"]),
                            max_distance: parseInt(d["max._distance"]),
                            number_incoming_domestic_flights: parseInt(d["number_incoming_domestic_flights"]),
                            number_incoming_flights: parseInt(d["number_incoming_flights"]),
                            number_incoming_international_flights: parseInt(d["number_incoming_international_flights"]),
                            number_of_routes: parseInt(d["number_of_routes"]),
                            number_outcoming_domestic_flights: parseInt(d["number_outcoming_domestic_flights"]),
                            number_outcoming_flights: parseInt(d["number_outcoming_flights"]),
                            number_outcoming_international_flights: parseInt(d["number_outcoming_international_flights"]),
                            only_domestic_flights: (d["only_domestic_flights"] == 1 ? true : false)
                        } 
                    });


                    initVis();
                }
                else {
                    console.log(error);
                }
            }
			
			
			// HELPERS 


            var dateFormat = d3.time.format("%Y-%m-%d");

            var startHere = function(){

            	queue()
                .defer(d3.json, 'data/openflight_db/citiesToCities_noduplicates.json')
                .defer(d3.csv, 'data/openflight_db/citiesTable.csv')
                .defer(d3.csv, 'data/openflight_db/completeTable.csv')  
                .defer(d3.json, 'data/openflight_db/airlineRoutesCounts.json')  
                .defer(d3.csv, 'data/openflight_db/countriesToCountries.csv') 
                .defer(d3.csv, 'data/countrylist.csv')
                .defer(d3.json, 'data/UNData.json')
				.await(dataLoaded);

            }

            startHere();
        })
    </script>
</body>
</html>